cmake_minimum_required (VERSION 2.8)

project (OpenCMISS Fortran C) 

#################Define OPENCMISS_ROOT & OPENCMISSEXTRAS_ROOT##################

# Set OPENCMISS_ROOT
IF(DEFINED ENV{OPENCMISS_ROOT})
  SET(OPENCMISS_ROOT $ENV{OPENCMISS_ROOT})
ELSE(DEFINED ENV{OPENCMISS_ROOT})
  SET(OPENCMISS_ROOT ..)
ENDIF(DEFINED ENV{OPENCMISS_ROOT})
SET(GLOBAL_CM_ROOT ${OPENCMISS_ROOT}/cm)
SET(GLOBAL_CELLML_ROOT ${OPENCMISS_ROOT}/cellml)

# Need some way of getting OPENCMISSEXTRAS_ROOT defined.
IF(DEFINED ENV{OPENCMISSEXTRAS_ROOT})
  set (OPENCMISSEXTRAS_ROOT $ENV{OPENCMISSEXTRAS_ROOT}) 
ELSE(DEFINED ENV{OPENCMISSEXTRAS_ROOT})
  set (OPENCMISSEXTRAS_ROOT ${OPENCMISS_ROOT}/../opencmissextras) 
ENDIF(DEFINED ENV{OPENCMISSEXTRAS_ROOT})
set (EXTERNAL_CM_ROOT ${OPENCMISSEXTRAS_ROOT}/cm/external)

SET(CMAKE_MODULE_PATH "${GLOBAL_CM_ROOT}/cmake_modules")
INCLUDE( ${CMAKE_MODULE_PATH}/GeneralConfiguration.cmake )
INCLUDE( ${CMAKE_MODULE_PATH}/MacroDefinitions.cmake )
INCLUDE( ${CMAKE_MODULE_PATH}/CompileFlags.cmake )
INCLUDE( ${CMAKE_MODULE_PATH}/FindPETSc.cmake )
INCLUDE( ${CMAKE_MODULE_PATH}/Entries.cmake )

# TODO remove
IF(${OPERATING_SYSTEM} MATCHES "linux")
  SET(CMAKE_C_COMPILER ${CMAKE_PREFIX_PATH}/bin/gcc)
  SET(CMAKE_Fortran_COMPILER ${CMAKE_PREFIX_PATH}/bin/gfortran)
  SET(CMAKE_LIBRARY_PATH ${CMAKE_PREFIX_PATH}/lib64)
ENDIF(${OPERATING_SYSTEM} MATCHES "linux")

#TODO
SET(CMAKE_Fortran_FLAGS "-ffree-form")
SET(CMAKE_Fortran_FLAGS "${CMAKE_Fortran_FLAGS} -pipe")
SET(CMAKE_Fortran_FLAGS "${CMAKE_Fortran_FLAGS} -fno-second-underscore")
SET(CMAKE_Fortran_FLAGS "${CMAKE_Fortran_FLAGS} -Wall")
SET(CMAKE_Fortran_FLAGS "${CMAKE_Fortran_FLAGS} -x f95-cpp-input")
SET(CMAKE_Fortran_FLAGS "${CMAKE_Fortran_FLAGS} -ffree-line-length-132")
SET(CMAKE_Fortran_FLAGS "${CMAKE_Fortran_FLAGS} -fmax-identifier-length=63")
SET(CMAKE_Fortran_FLAGS "${CMAKE_Fortran_FLAGS} -m64 -march=nocona")
SET(CMAKE_Fortran_FLAGS "${CMAKE_Fortran_FLAGS} -g")
SET(CMAKE_Fortran_FLAGS "${CMAKE_Fortran_FLAGS} -fPIC")
SET(CMAKE_Fortran_FLAGS "${CMAKE_Fortran_FLAGS} -O0")
SET(CMAKE_Fortran_FLAGS "${CMAKE_Fortran_FLAGS} -fbounds-check")

SET(LIBRARY_TARGET_NAME OpenCMISS-debug)
SET(LIBRARY_BUILD_TYPE STATIC)
SET(LIBRARY_INSTALL_TYPE ARCHIVE)

SET (SOURCE_DIR ${GLOBAL_CM_ROOT}/src)

SET(OPENCMISS_SRCS ${SOURCE_DIR}/opencmiss.f90)
FOREACH(OPENCMISS_ENTRY ${OPENCMISS_ENTRIES})
  IF(EXISTS ${SOURCE_DIR}/${OPENCMISS_ENTRY}.f90)
    LIST(APPEND OPENCMISS_SRCS ${SOURCE_DIR}/${OPENCMISS_ENTRY}.f90)
  ELSEIF(EXISTS ${SOURCE_DIR}/${OPENCMISS_ENTRY}.c)
    LIST(APPEND OPENCMISS_SRCS ${SOURCE_DIR}/${OPENCMISS_ENTRY}.c)
  ENDIF(EXISTS ${SOURCE_DIR}/${OPENCMISS_ENTRY}.f90)
ENDFOREACH(OPENCMISS_ENTRY)
LIST(REMOVE_DUPLICATES OPENCMISS_SRCS)

ADD_LIBRARY(${LIBRARY_TARGET_NAME} ${LIBRARY_BUILD_TYPE} ${OPENCMISS_SRCS} ${PUBLIC_HDRS} ${PRIVATE_HDRS})

SET(CMAKE_INSTALL_PREFIX ${GLOBAL_CM_ROOT})

SET(OPENCMISS_INCLUDES)

INSTALL(TARGETS ${LIBRARY_TARGET_NAME} ${LIBRARY_INSTALL_TYPE} DESTINATION lib/x86_64-linux/mpich2/gnu)
INSTALL(FILES ${CMAKE_BINARY_DIR}/opencmiss.mod DESTINATION include/x86_64-linux/mpich2/gnu)

SET(OPENCMISS_MODS ${CMAKE_BINARY_DIR}/opencmiss.mod)
FOREACH(OPENCMISS_ENTRY ${OPENCMISS_ENTRIES})
  LIST(APPEND OPENCMISS_MODS ${CMAKE_BINARY_DIR}/${OPENCMISS_ENTRY}.mod)
ENDFOREACH(OPENCMISS_ENTRY)
LIST(REMOVE_DUPLICATES OPENCMISS_MODS)

INSTALL(FILES ${OPENCMISS_MODS} DESTINATION include/x86_64-linux/mpich2/gnu)


