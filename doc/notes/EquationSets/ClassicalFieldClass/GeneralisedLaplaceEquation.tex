\subsection{Generalised Laplace Equation}

\subsubsection{Governing equations:}
The generalised Laplace's equation on a domain $\Omega$ with boundary $\Gamma$
can be stated as
\begin{equation}
  \diverg{\pbrac{\tensor{\sigma}\grad\phi}}=0
  \label{eqn:Laplacesequation}
\end{equation}
where $\phi$ is the potential throughout the domain and $\tensor{\sigma}$ is
the conductivity tensor throughout the domain. Note that 
$\tensor{\sigma}=\tensor{I}$ gives the standard form of Laplace's equation \ie $\laplacian{\phi}=0$

\subsubsection{Weak formulation:}
The corresponding weak form of the equation \eqnref{eqn:Laplacesequation} is
\begin{equation}
  \gint{\Omega}{}{\diverg{\pbrac{\tensor{\sigma}\grad\phi}}w}{\Omega}=0 \,,
  \label{eqn:Laplaceweakform}
\end{equation}
where $w$ is a suitable test function.

Applying Green's theorem to \eqnref{eqn:Laplaceweakform} gives
\begin{equation}
 \gint{\Omega}{}{\diverg{\pbrac{\tensor{\sigma}\grad\phi}}w}{\Omega}
 = -\gint{\Omega}{}{\dotprod{\pbrac{\tensor{\sigma}\grad\phi}}{\grad w}}{\Omega}
   +\gint{\Gamma}{}{\dotprod{\pbrac{\tensor{\sigma}\grad\phi}}{\vect{n}}w}{\Gamma}
 = 0
\end{equation}
or
\begin{equation}
  \gint{\Omega}{}{\dotprod{\pbrac{\tensor{\sigma}\grad\phi}}{\grad w}}{\Omega}
  = -\gint{\Gamma}{}{\dotprod{\pbrac{\tensor{\sigma}\grad\phi}}{\vect{n}w}}{\Gamma} \,,
  \label{eqn:Laplaceweightedresidualform}
\end{equation}
where $\vect{n}$ is the unit outward normal vector to the boundary~$\Gamma$.

\subsubsection{Tensor notation:}
If we now consider the integrand of the left hand side of
\eqnref{eqn:Laplaceweightedresidualform} in tensorial form with covariant
derivatives indicated by a semi-colon in the index
(see \secref{subsec:function derivatives} for details) then
\begin{equation}
  \tensor{\sigma}\grad\phi = \sigma^{i}_{j}\covarderiv{\phi}{i}
  \label{eqn:Laplace weak form factor1}
\end{equation}
and
\begin{equation}
  \grad w = \covarderiv{w}{i}
  \label{eqn:Laplace weak form factor2}
\end{equation}

Now, Equations (\ref{eqn:Laplace weak form factor1}) and (\ref{eqn:Laplace weak form factor2})
represent vectors that are covariant and
therefore we must convert Equation (\ref{eqn:Laplace weak form factor1})
to a contravariant vector by 
multiplying by the contravariant metric tensor (from $\vect{i}$ to $\vect{x}$ 
coordinates) so that we can take the dot product. The final tensorial form is
\begin{equation}
  \dotprod{\pbrac{\tensor{\sigma}\grad\phi}}{\grad w} = G^{jk}\sigma^{i}_{j}\covarderiv{\phi}{i}\covarderiv{w}{k}
\end{equation}
and thus \eqnref{eqn:Laplaceweightedresidualform} becomes
\begin{equation}
  \gint{\Omega}{}{G^{jk}\sigma^{i}_{j}\covarderiv{\phi}{i}\covarderiv{w}{k}}{\Omega}
  = -\gint{\Gamma}{}{\dotprod{\pbrac{\tensor{\sigma}\grad\phi}}{\vect{n}w}}{\Gamma}
  \label{eqn:Laplaceweightedresidualtensorform}
\end{equation}

\subsubsection{Finite element formulation:}
We can now discretise the domain into finite elements \ie $\Omega=
\displaystyle{\bigcup_{e=1}^{E}}\Omega_{e}$, the left hand side of
\eqnref{eqn:Laplaceweightedresidualtensorform} becomes
\begin{equation}
  \dsum_{e=1}^{E}\gint{\Omega_{e}}{}{G^{jk}\sigma^{i}_{j}\covarderiv{\phi}{i}\covarderiv{w}{k}}{\Omega}
\end{equation}

The next step is to approximate the dependent variable, $\phi$, using basis
functions. To simplify this for different types of basis functions an
\emph{interpolation notation} is adopted. This
interpolation is such that $\gbfn{\alpha}{u}{\vect{\xi}}$ are the appropriate
basis functions for the type of element (\eg \bicubicherm, Hermite-sector,
\etc) and dimension of the problem (one, two or \threedal). For example if
$\vect{\xi}=\bbrac{\xi}$ and the element is a cubic Hermite element 
(\secref{sec:Hermitianbasisfunctions}) then
$\gbfn{\alpha}{u}{\vect{\xi}}$ are the cubic Hermite basis functions where
the local node number $\alpha$ ranges from $1$ to $2$ and $u$ ranges from $0$ to $1$. 
If, however, $\vect{\xi}=\bbrac{\xione,\xitwo}$ and the element is a \bicubicherm element
then $\alpha$ ranges from $1$ to $4$, $u$ ranges from $0$ to $3$ and
$\gbfn{\alpha}{u}{\vect{\xi}}$ is the appropriate basis function for the nodal
variable $\nodedof{\phi}{\alpha}{u}$. The nodal variables are defined as
follows: $\nodedof{\phi}{\alpha}{0}=\nodept{\phi}{\alpha}$,
$\nodedof{\phi}{\alpha}{1}=\delby{\nodept{\phi}{\alpha}}{s_{1}}$,
$\nodedof{\phi}{\alpha}{2}=\delby{\nodept{\phi}{\alpha}}{s_{2}}$,
$\nodedof{\phi}{\alpha}{3}=\deltwoby{\nodept{\phi}{\alpha}}{s_{1}}{s_{2}}$,
\etc Hence for the \bicubicherm element the interpolation function
$\gbfn{2}{3}{\vect{\xi}}$ multiplies the nodal variable
$\phi^{2}_{,3}=\deltwoby{\phi^{2}}{s_{1}}{s_{2}}$ and thus the
interpolation function is $\chbfn{2}{1}{\xione}\chbfn{1}{1}{\xitwo}$.  The
scale factors for the Hermite interpolation are handled by the introduction of
an interpolation scale factor $\gsf{\alpha}{u}$ defined as follows:
$\gsf{\alpha}{0}=1$, $\gsf{\alpha}{1}=\nsftwo{\alpha}{1}$, $\gsf{\alpha}{2}=
\nsftwo{\alpha}{2}$, $\gsf{\alpha}{3}=\nsftwo{\alpha}{1}\nsftwo{\alpha}{2}$,
\etc For Lagrangian basis functions the interpolation scale factors are all
one. The general form of the interpolation notation for $\phi$ is then
\begin{equation}
  \fnof{\phi}{\vect{\xi}}=\gbfn{\alpha}{u}{\vect{\xi}}\nodedof{\phi}
  {\alpha}{u}\gsf{(\alpha)}{(u)}
  \label{eqn:phiinterpolation}
\end{equation}

\subsubsection{Spatial integration:}
When dealing with integrals a similar interpolation notation is adopted in
that $d\vect{\xi}$ is the appropriate infinitesimal for the dimension of the
problem. The limits of the integral are also written in bold font and indicate
the appropriate number of integrals for the dimension of the problem.  For
example if $\vect{\xi}=\bbrac{\xione,\xitwo}$ then
$\gint{\vect{0}}{\vect{1}}{x}
{\vect{\xi}}=\giint{0}{1}{0}{1}{x}{\xione}{\xitwo}$, but if $\vect{\xi}=
\bbrac{\xione,\xitwo,\xithree}$ then $\gint{\vect{0}}{\vect{1}}{x}
{\vect{\xi}}=\dintl{0}{1}\!\dintl{0}{1}\!\dintl{0}{1}\,x\,d\xione d\xitwo
d\xithree$.

In order to integrate in $\vect{\xi}$ coordinates we must convert the spatial
derivatives to derivatives with respect to $\vect{\xi}$. Using the tensor
transformation equations for a covariant vector we have
\begin{equation}  
  \covarderiv{\phi}{i}=\delby{\xi^{r}}{x^{i}}\covarderiv{\phi}{r}=\delby{\xi^{r}}{x^{i}}\delby{\phi}{\xi^{r}}
\end{equation}
and 
\begin{equation}
  \covarderiv{w}{k}=\delby{\xi^{s}}{x^{k}}\covarderiv{w}{s}=\delby{\xi^{s}}{x^{k}}\delby{w}{\xi^{s}}
\end{equation}

Now as we only know $\tensor{\tilde{\sigma}}$, the conductivity in the
$\vect{\nu}$ (fibre) coordinate system rather than $\tensor{\sigma}$, the
conductivity in the $\vect{x}$ (geometric) coordinate system, we must transform the mixed
tensor ${\tilde{\sigma}}^{a}_{.b}$ from $\vect{\nu}$ to $\vect{x}$ coordinates. However, as the
fibre coordinate system is defined in terms of $\vect{\xi}$ coordinates we
first transform the conductivity tensor from $\vect{\nu}$ to $\vect{\xi}$
coordinates \ie
\begin{equation}
  \sigma^{p}_{.q}=\delby{\xi^{p}}{\nu^{a}}\delby{\nu^{b}}{\xi^{q}}{\tilde{\sigma}}^{a}_{.b}
\end{equation}
with $.b$ indicating that $b$ is the ``second'' index (\secref{subsec:summation notation}),
and then transform the conductivity from $\vect{\xi}$ coordinates to
$\vect{x}$ coordinates \ie
\begin{equation}
  \begin{split}
    \sigma^{i}_{.j} &= \delby{x^{i}}{\xi^{p}}\delby{\xi^{q}}{x^{j}}{\sigma}^{p}_{.q} \\
    &= \delby{x^{i}}{\xi^{p}}\delby{\xi^{q}}{x^{j}}\delby{\xi^{p}} 
    {\nu^{a}}\delby{\nu^{b}}{\xi^{q}}{\tilde{\sigma}}^{a}_{.b}
  \end{split}
\end{equation}

Now, using an interpolated dependent variable and a Galerkin finite element
approach (where the weighting functions are chosen to be the interpolating
basis functions \ie $w=\gbfn{\beta}{v}{\vect{\xi}}\gsf{(\beta)}{(v)}$) yields
\begin{equation}
  \dsum_{e=1}^{E}\gint{\vect{0}}{\vect{1}}{G^{jk}\delby{x^{i}}{\xi^{p}}
    \delby{\xi^{q}}{x^{j}}\delby{\xi^{p}} {\nu^{a}}
    \delby{\nu^{b}}{\xi^{q}}{\tilde{\sigma}}^{a}_{.b}\delby{\xi^{r}}{x^{i}}
    \delby{\pbrac{\gbfn{\alpha}{u}{\vect{\xi}}\nodedof{\phi}{\alpha}{u}\gsf{(\alpha)}{(u)}}}{\xi^{r}}
    \delby{\xi^{s}}{x^{k}}\delby{\pbrac{\gbfn{\beta}{v}{\vect{\xi}}\gsf{(\beta)}{(v)}}}{\xi^{s}}
    \abs{\fnof{\matr{J}}{\vect{\xi}}}}{\vect{\xi}}
\end{equation}
where $\fnof{\matr{J}}{\vect{\xi}}$ is the \emph{Jacobian} of the
transformation from the integration $\vect{x}$ to $\vect{\xi}$ coordinates.

Taking the fixed nodal degrees-of-freedom and scale factors outside the integral we have
\begin{equation}
  \dsum_{e=1}^{E}\nodedof{\phi}{\alpha}{u}\gsf{(\alpha)}{(u)}\gsf{(\beta)}{(v)}
  \gint{\vect{0}}{\vect{1}}{G^{jk}\delby{x^{i}}{\xi^{p}}
    \delby{\xi^{q}}{x^{j}}\delby{\xi^{p}} {\nu^{a}}
    \delby{\nu^{b}}{\xi^{q}}{\tilde{\sigma}}^{a}_{.b}\delby{\xi^{r}}{x^{i}}
    \delby{\gbfn{\alpha}{u}{\vect{\xi}}}{\xi^{r}}
    \delby{\xi^{s}}{x^{k}}\delby{\gbfn{\beta}{v}{\vect{\xi}}}{\xi^{s}}
    \abs{\fnof{\matr{J}}{\vect{\xi}}}}{\vect{\xi}}
  \label{eqn:elementalfemlhs1}
\end{equation}
or
\begin{equation}
  \dsum_{e=1}^{E}\nodedof{\phi}{\alpha}{u}\gsf{(\alpha)}{(u)}\gsf{(\beta)}{(v)}
  \gint{\vect{0}}{\vect{1}}{\delby{\gbfn{\alpha}{u}{\vect{\xi}}}{\xi^{r}}\delby{\gbfn{\beta}{v}{\vect{\xi}}}{\xi^{s}}\gamma^{rs}
    \abs{\fnof{\matr{J}}{\vect{\xi}}}}{\vect{\xi}}
  \label{eqn:elementalfemlhs2}
\end{equation}
where
\begin{equation}
  \gamma^{rs}=G^{jk}\delby{x^{i}}{\xi^{p}}
    \delby{\xi^{q}}{x^{j}}\delby{\xi^{p}} {\nu^{a}}
    \delby{\nu^{b}}{\xi^{q}}{\tilde{\sigma}}^{a}_{.b}\delby{\xi^{r}}{x^{i}}\delby{\xi^{s}}{x^{k}}
\end{equation}

Note that for Laplace's equation with no conductivity or fibre fields then we have
\begin{equation}
  \gamma^{rs}=G^{ik}\delby{\xi^{r}}{x^{i}}\delby{\xi^{s}}{x^{k}}
\end{equation}
and that for rectangular-Cartesian coordinates systems
$G^{ik}=\contrakronecker{i}{k}$ and thus $i=k$. This now gives
\begin{equation}
  \gamma^{rs}=\delby{\xi^{r}}{x^{i}}\delby{\xi^{s}}{x^{i}}=g^{rs}
  \label{eqn:contrametrictensor}
\end{equation}
where $g^{rs}$ is the \emph{contravariant metric tensor} from $\vect{x}$ to
$\vect{\xi}$ coordinates. It may thus be helpful to think about $\gamma^{rs}$
as a scaled/transformed contravariant metric tensor.

\subsubsection{Coded OpenCMISS formulation:}
Finally, we use the Gaussian quadrature rule (see Section~???), 
usually stated as a weighted sum of function values at specified Gauss points within the domain of integration. An $n$-point Gaussian quadrature rule yields an exact result for polynomials of degree $2n-1$ or less by a suitable choice of the points $x_i$ and weights $g_i$ for $i = 1,...,n$. Consequently, the formulation implemented can be derived from Equation (\ref{eqn:elementalfemlhs2}) as: 
\begin{equation}
  \boxed{
  \dsum_{e=1}^{E}\nodedof{\phi}{\alpha}{u}\gsf{(\alpha)}{(u)} \gsf{(\beta)}{(v)}
  \dsum_{i=1}^{n}
  \left(\delby{\gbfn{\alpha}{u}{\vect{\xi}}}{\xi^{r}}
  \delby{\gbfn{\beta}{v}{\vect{\xi}}}{\xi^{s}}\gamma^{rs}\abs{\fnof{\matr{J}}{\vect{\xi}}}
  \right)(x_i)g_i
  }
  \label{eqn:Laplaceweightedresidualtensorform in OpenCMISS}
\end{equation}


\newpage
\subsubsection{OpenCMISS implementation}

For exemplification, we briefly discuss here a code snippet
that evaluates the expression~(\ref{eqn:Laplaceweightedresidualtensorform in OpenCMISS})
(still needs to be finished / discussed and maybe number of lines needs to be reduced):

{\footnotesize
\begin{lstlisting}
SUBROUTINE LAPLACE_EQUATION_FINITE_ELEMENT_CALCULATE(EQUATIONS_SET,ELEMENT_NUMBER, &
  & ERR,ERROR,*)
  ...
  DO ng=1,QUADRATURE_SCHEME%NUMBER_OF_GAUSS
    ...
    RWG=EQUATIONS%INTERPOLATION%GEOMETRIC_INTERP_POINT_METRICS(FIELD_U_VARIABLE_TYPE)% &
      & PTR%JACOBIAN*QUADRATURE_SCHEME%GAUSS_WEIGHTS(ng)
    !Loop over field components
    mhs=0          
    DO mh=1,FIELD_VARIABLE%NUMBER_OF_COMPONENTS
      !Loop over element rows
      DO ms=1,DEPENDENT_BASIS%NUMBER_OF_ELEMENT_PARAMETERS
        mhs=mhs+1
        nhs=0
        IF(EQUATIONS_MATRIX%UPDATE_MATRIX) THEN
          !Loop over element columns
          DO nh=1,FIELD_VARIABLE%NUMBER_OF_COMPONENTS
            DO ns=1,DEPENDENT_BASIS%NUMBER_OF_ELEMENT_PARAMETERS
              nhs=nhs+1
              DO ni=1,DEPENDENT_BASIS%NUMBER_OF_XI
                PGMSI(ni)=QUADRATURE_SCHEME%GAUSS_BASIS_FNS(ms, &
                  & PARTIAL_DERIVATIVE_FIRST_DERIVATIVE_MAP(ni),ng)
                PGNSI(ni)=QUADRATURE_SCHEME%GAUSS_BASIS_FNS(ns, &
                  & PARTIAL_DERIVATIVE_FIRST_DERIVATIVE_MAP(ni),ng)
              ENDDO !ni

              SUM=0.0_DP
              DO mi=1,DEPENDENT_BASIS%NUMBER_OF_XI
                DO ni=1,DEPENDENT_BASIS%NUMBER_OF_XI
                  SUM=SUM+PGMSI(mi)*PGNSI(ni)*EQUATIONS%INTERPOLATION% &
                    & GEOMETRIC_INTERP_POINT_METRICS(FIELD_U_VARIABLE_TYPE)%PTR%GU(mi,ni)
                ENDDO !ni
              ENDDO !mi
              EQUATIONS_MATRIX%ELEMENT_MATRIX%MATRIX(mhs,nhs)=EQUATIONS_MATRIX% &
                & ELEMENT_MATRIX%MATRIX(mhs,nhs)+SUM*RWG

            ENDDO !ns
          ENDDO !nh
        ENDIF
      ENDDO !ms
    ENDDO !mh
  ENDDO !ng
\end{lstlisting}
}
